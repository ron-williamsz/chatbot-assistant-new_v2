<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar API Keys - Admin</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">API Keys</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/admin/assistants" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-robot mr-2"></i>Assistentes
                    </a>
                    <a href="/admin/users" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-users mr-2"></i>Usuários
                    </a>
                    <a href="/admin/wallets" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-wallet mr-2"></i>Carteiras
                    </a>
                    <a href="/admin/security" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-shield-alt mr-2"></i>Segurança
                    </a>
                    <a href="/auth/logout" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sair
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="md:flex md:items-center md:justify-between mb-8">
            <div class="flex-1 min-w-0">
                <h2 class="text-2xl font-bold text-gray-900">Gerenciar API Keys</h2>
                <p class="mt-1 text-sm text-gray-500">Crie e gerencie chaves de API para acesso externo</p>
            </div>
            <div class="mt-4 flex md:mt-0 md:ml-4">
                <button onclick="openCreateModal()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-plus mr-2"></i>
                    Nova API Key
                </button>
            </div>
        </div>

        <!-- API Keys List -->
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <div id="loadingState" class="hidden p-8 text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-500">Carregando API Keys...</p>
            </div>
            
            <div id="apiKeysList">
                <!-- Lista será carregada aqui -->
            </div>
        </div>
    </main>

    <!-- Modal Criar API Key -->
    <div id="createModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Nova API Key</h3>
                <button onclick="closeCreateModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="createForm" class="space-y-4">
                <div>
                    <label for="keyName" class="block text-sm font-medium text-gray-700 mb-2">Nome da API Key</label>
                    <input type="text" id="keyName" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                           placeholder="Ex: Sistema de Integração">
                </div>

                <div>
                    <label for="keyDescription" class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                    <textarea id="keyDescription" name="description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                              placeholder="Descrição opcional da API key"></textarea>
                </div>

                <div>
                    <label for="keyPermissions" class="block text-sm font-medium text-gray-700 mb-2">Permissões</label>
                    <select id="keyPermissions" name="permissions"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="read">Somente Leitura</option>
                        <option value="write">Leitura e Escrita</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>

                <div>
                    <label for="keyExpires" class="block text-sm font-medium text-gray-700 mb-2">Expiração</label>
                    <select id="keyExpires" name="expires_days"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="">Nunca expira</option>
                        <option value="30">30 dias</option>
                        <option value="90">90 dias</option>
                        <option value="365">1 ano</option>
                    </select>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeCreateModal()"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        Criar API Key
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Exibir API Key -->
    <div id="showKeyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-xl bg-white">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-900">API Key Criada</h3>
                <button onclick="closeShowKeyModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <div class="flex">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
                    <div>
                        <h4 class="text-sm font-medium text-yellow-800">Importante!</h4>
                        <p class="text-sm text-yellow-700 mt-1">
                            Esta é a única vez que você verá esta API key. Copie e guarde em local seguro.
                        </p>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Sua nova API Key:</label>
                <div class="flex">
                    <input type="text" id="newApiKey" readonly
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50 text-sm font-mono"
                           placeholder="Carregando...">
                    <button onclick="copyApiKey()" id="copyButton"
                            class="px-4 py-2 bg-primary-600 text-white rounded-r-lg hover:bg-primary-700 focus:outline-none">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>

            <div class="mt-6">
                <button onclick="closeShowKeyModal()"
                        class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        let apiKeys = [];
        let isLoading = false;

        // Carregar API keys ao inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadApiKeys();
        });

        // Carregar lista de API keys
        async function loadApiKeys() {
            if (isLoading) return;
            isLoading = true;
            
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('apiKeysList').innerHTML = '';

            try {
                const response = await fetch('/admin/api/api-keys');
                const data = await response.json();

                if (data.api_keys) {
                    apiKeys = data.api_keys;
                    renderApiKeys();
                } else {
                    showAlert('Erro ao carregar API keys', 'error');
                }
            } catch (error) {
                showAlert('Erro ao carregar API keys', 'error');
                console.error(error);
            } finally {
                document.getElementById('loadingState').classList.add('hidden');
                isLoading = false;
            }
        }

        // Renderizar lista de API keys
        function renderApiKeys() {
            const container = document.getElementById('apiKeysList');
            
            if (apiKeys.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-key text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Nenhuma API key encontrada</p>
                        <p class="text-gray-400 text-sm mt-2">Crie sua primeira API key para começar</p>
                    </div>
                `;
                return;
            }

            const keysHtml = apiKeys.map(key => {
                const createdDate = new Date(key.created_at * 1000).toLocaleDateString('pt-BR');
                const lastUsedDate = key.last_used ? new Date(key.last_used * 1000).toLocaleDateString('pt-BR') : 'Nunca';
                const expiresDate = key.expires_at ? new Date(key.expires_at * 1000).toLocaleDateString('pt-BR') : 'Nunca';
                
                const statusBadge = key.is_active ? 
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Ativa</span>' :
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Inativa</span>';

                const permissionsBadge = {
                    'read': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Leitura</span>',
                    'write': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Escrita</span>',
                    'admin': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">Admin</span>'
                }[key.permissions];

                return `
                    <li class="border-b border-gray-200 last:border-b-0">
                        <div class="px-6 py-4">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3">
                                        <h3 class="text-lg font-medium text-gray-900">${key.key_name}</h3>
                                        ${statusBadge}
                                        ${permissionsBadge}
                                    </div>
                                    
                                    <div class="mt-2 text-sm text-gray-500">
                                        <p><strong>API Key:</strong> ${key.api_key_preview}</p>
                                        ${key.description ? `<p><strong>Descrição:</strong> ${key.description}</p>` : ''}
                                        <p><strong>Criado em:</strong> ${createdDate} por ${key.created_by_username || 'Sistema'}</p>
                                        <p><strong>Último uso:</strong> ${lastUsedDate}</p>
                                        <p><strong>Expira em:</strong> ${expiresDate}</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <button onclick="toggleApiKey(${key.id}, ${!key.is_active})" 
                                            class="inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                        <i class="fas fa-${key.is_active ? 'pause' : 'play'} mr-2"></i>
                                        ${key.is_active ? 'Desativar' : 'Ativar'}
                                    </button>
                                    
                                    <button onclick="deleteApiKey(${key.id})" 
                                            class="inline-flex items-center px-3 py-1 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                        <i class="fas fa-trash mr-2"></i>
                                        Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');

            container.innerHTML = `<ul class="divide-y divide-gray-200">${keysHtml}</ul>`;
        }

        // Modais
        function openCreateModal() {
            document.getElementById('createModal').classList.remove('hidden');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.add('hidden');
            document.getElementById('createForm').reset();
        }

        function closeShowKeyModal() {
            document.getElementById('showKeyModal').classList.add('hidden');
            document.getElementById('newApiKey').value = '';
        }

        // Criar nova API key
        document.getElementById('createForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Converter expires_days para número ou null
            if (data.expires_days) {
                data.expires_days = parseInt(data.expires_days);
            } else {
                delete data.expires_days;
            }

            try {
                const response = await fetch('/admin/api/api-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    closeCreateModal();
                    
                    // Mostrar a API key gerada
                    document.getElementById('newApiKey').value = result.api_key;
                    document.getElementById('showKeyModal').classList.remove('hidden');
                    
                    // Recarregar lista
                    loadApiKeys();
                    
                    showAlert('API key criada com sucesso', 'success');
                } else {
                    showAlert(result.error || 'Erro ao criar API key', 'error');
                }
            } catch (error) {
                showAlert('Erro ao criar API key', 'error');
                console.error(error);
            }
        });

        // Copiar API key
        function copyApiKey() {
            const input = document.getElementById('newApiKey');
            input.select();
            document.execCommand('copy');
            
            const button = document.getElementById('copyButton');
            const originalHtml = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i>';
            
            setTimeout(() => {
                button.innerHTML = originalHtml;
            }, 2000);
        }

        // Alternar status da API key
        async function toggleApiKey(keyId, isActive) {
            try {
                const response = await fetch(`/admin/api/api-keys/${keyId}/toggle`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(result.message, 'success');
                    loadApiKeys();
                } else {
                    showAlert(result.error || 'Erro ao alterar status', 'error');
                }
            } catch (error) {
                showAlert('Erro ao alterar status', 'error');
                console.error(error);
            }
        }

        // Deletar API key
        async function deleteApiKey(keyId) {
            if (!confirm('Tem certeza que deseja excluir esta API key? Esta ação não pode ser desfeita.')) {
                return;
            }

            try {
                const response = await fetch(`/admin/api/api-keys/${keyId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(result.message, 'success');
                    loadApiKeys();
                } else {
                    showAlert(result.error || 'Erro ao excluir API key', 'error');
                }
            } catch (error) {
                showAlert('Erro ao excluir API key', 'error');
                console.error(error);
            }
        }

        // Função para mostrar alertas
        function showAlert(message, type = 'info') {
            // Remover alertas existentes
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alertColors = {
                success: 'bg-green-100 border-green-500 text-green-700',
                error: 'bg-red-100 border-red-500 text-red-700',
                warning: 'bg-yellow-100 border-yellow-500 text-yellow-700',
                info: 'bg-blue-100 border-blue-500 text-blue-700'
            };

            const alert = document.createElement('div');
            alert.className = `alert fixed top-4 right-4 px-4 py-3 rounded border-l-4 ${alertColors[type]} shadow-lg z-50`;
            alert.innerHTML = `
                <div class="flex items-center">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg leading-none">&times;</button>
                </div>
            `;

            document.body.appendChild(alert);

            // Auto-remove após 5 segundos
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html> 